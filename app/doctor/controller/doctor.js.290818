(function() {   
    'use strict';   
    angular
        .module('AkosPCP.doctor')
        .controller('DoctorCtrl', DoctorCtrl);
    DoctorCtrl.$inject = ['$scope','$http','$rootScope','$location','$window','$log','doctorServices','tokenValidatorService','$cookieStore','$state','$uibModal','moment','config','socketService','$filter','pdfChartingService','$compile','$interval','appConfig','Upload'];
    function DoctorCtrl($scope,$http,$rootScope,$location,$window,$log,doctorServices,tokenValidatorService,$cookieStore,$state,$uibModal,moment,config,socketService,$filter,pdfChartingService,$compile,$interval,appConfig,Upload,sessionResolve) {

        // $scope.testScope = "test";
        // $rootScope.$emit('event',$scope.testScope);
        // $scope.$on('event', function(events,args){
        //     alert(1);
        //     $log.log(events);
        //     $log.log(args);
        // })

        $scope.clientURL = $location.absUrl().split("/#!")[0];
        $scope.$on('$destroy', function (event) {
            //socket.removeAllListeners();
            socketService.removeAllListeners();
            //console.log('destroy triggered!');
        });
        //var vm = this;
        
        // on doc side: - doc get msg ---> .on()
        //on patient side : -- patient send msg --> /emit()
        //socketService.connect();
        /* login controller start*/
        $rootScope.title = "Login";

        $rootScope.pcpDoctorOpentokSession = '';
        
        if(JSON.parse(localStorage.getItem('connect_provider_settings')) != undefined && JSON.parse(localStorage.getItem('connect_provider_settings')).type == "WC_NURSE" && localStorage.getItem('doc_token')){
            let waitingname = 12;
            let onlineDoctorId =   document.createElement('div');
            onlineDoctorId.classList.add('onlineDoctorClass');
            document.body.appendChild(onlineDoctorId);
            $log.log(onlineDoctorId);
            onlineDoctorId.innerHTML = "<span data-toggle='tooltip' title='Online Doctors'>&#171;</span>";  
            onlineDoctorId.onclick = function(){
                $rootScope.callOnlineDoctor();
            }
        }else{
            let removeOnlienDoctor = document.getElementsByClassName('onlineDoctorClass')[0];
            if(removeOnlienDoctor) removeOnlienDoctor.parentNode.removeChild(removeOnlienDoctor);
        }
        
        
        
        
        $scope.loginForm = function(x){
            $scope.loading = true;
            $scope.loginData = x;
            /*added 250718*/
            $scope.loginData.employerId = appConfig.employerId;
            /*------------*/
            doctorServices.doctorLogin($scope.loginData)
            .then(function(result){
                if(result.data.status_code == 200){
                    
                    $scope.loading = false;
                    localStorage.setItem('doc_token',result.data.result.token);
                    localStorage.setItem('pcpDocData',JSON.stringify(result.data.result));
                    var docid = result.data.result.id;
                    $rootScope.docData = JSON.parse(localStorage.getItem('pcpDocData'));//$cookieStore.get('pcpDocData')
                    tokenValidatorService.setDocAuthToken(result.data.result.token); 
                    if($rootScope.docData.group_id == 0){
                       if($rootScope.docData.room_alias != ''){
                            $scope.connectProviderSettingParam = $rootScope.docData.room_alias;
                            $rootScope.docData.room = $rootScope.docData.room_alias;
                            $scope.getProviderSettingScope($scope.connectProviderSettingParam);
                        }else{
                            $scope.connectProviderSettingParam = $rootScope.docData.room;
                            $scope.getProviderSettingScope($scope.connectProviderSettingParam);
                        } 
                    }else{
                        doctorServices.getRoomFromGroupId($rootScope.docData.group_id)
                        .then(function(result){
                            if(result.data.status_code == 200){
                                //$scope.universalRoom = result.data.result[0].room;        
                                $rootScope.docData.room_alias = result.data.result[0].room;
                                var data = JSON.parse(localStorage.getItem('pcpDocData'));
                                data.room_alias = result.data.result[0].room;
                                localStorage.setItem('pcpDocData', JSON.stringify(data));
                                $scope.getProviderSettingScope(result.data.result[0].room);
								//added on 070818
								$rootScope.$emit('grouproomalias', data);
                            }else{
                                alert("error");
                            }
                        });
                    }
                    socketService.emit('doctorGoneOnline', { docId: docid }, function (data) {
                        $log.log(data);
                    });
                    //$location.path('/doctor'); 
                    $state.go('doctor');
                }else{


                    $('#showInvalidMsg').html('<div class="alert alert-danger alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+result.data.status_message+'</div>');
                    $scope.loading = false;
                    //alert("error");
                    return false;
                }
                
                });
        }
        $scope.file_changed = function (element) {
           
            $scope.$apply(function (scope) {
                var photofile = element.files[0];
               
                $scope.upload(photofile);

               
            })
        }
        $scope.upload = function (file) {
            $scope.loading = true;
            Upload.upload({
                url: config.serverBaseUrl + '/api/pcp/uploadfileonbucket',// + 'api/photo',
                data: { file: file }

            }).then(function (resp) {
				  $scope.loading = false;
               
                    var modalInstance = $uibModal.open({
                        template: '<div class="modal-header bootstrap-modal-header">\
                                                    <h3 class="modal-title" id="modal-title">Upload Location </h3>\
                                                    </div>\
                                                    <div class="modal-body bootstrap-modal-body" id="modal-body">\
                                                    <p>'+ resp.data.status_message+'</p>\
                                                    </div>\
                                                    <div class="modal-footer bootstrap-modal-footer">\
                                                        <button class="btn btn-primary" type="button" ng-click="cancel()">OK</button>\
                                                    </div>\
                                                    ',
                        controller: ModalInstanceCtrl,
                        scope: $scope,
                        size: 'sm',
                        windowClass: 'sendpatient-email-pop-class',
                        resolve: {
                            modalProgressValue: function () {
                                return "";
                            },
                            CPTBilling: function () {
                                return "";
                            },
                            sessionResolve: function () {
                                return '';
                            },
                            meetingRoomURLResolve: function () {
                                return "";
                            },
                            emailMeetingLinkUrlResolve: function () {
                                return '';
                            },
                            lockEncounterData: function () {
                                return "";
                            },
                            disconnectData: function () {
                                return "";
                            }
                        }

                    });
                    modalInstance.result.then(function (selectedItem) {
                        $scope.selected = selectedItem;
                    }, function () {
                        $log.info('Modal dismissed at: ' + new Date());
                    });
                
            }, function (resp) { //catch error
	            $scope.loading = false;
               // console.log('Error status: ' + resp.error);
                alert('Something went wrong. Please try again' );
            }, function (evt) {
               // console.log(evt);
                // var progressPercentage = parseInt(100.0 * evt.loaded / evt.total);
                // console.log('progress: ' + progressPercentage + '% ' + evt.config.data.file.name);
                // vm.progress = 'progress: ' + progressPercentage + '% '; // capture upload progress
            });
        };
        $scope.getProviderSettingScope = function(x){
            doctorServices.getProviderSetting(x)
            .then(function(result){
                if(result.data.status_code == 200){
                    localStorage.setItem('connect_provider_settings',JSON.stringify(result.data.result[0]));
                    if(JSON.parse(localStorage.getItem('connect_provider_settings')) != undefined && JSON.parse(localStorage.getItem('connect_provider_settings')).type == "WC_NURSE" && localStorage.getItem('doc_token')){
                        let waitingname = 12;
                        let onlineDoctorId =   document.createElement('div');
                        onlineDoctorId.classList.add('onlineDoctorClass');
                        document.body.appendChild(onlineDoctorId);
                        $log.log(onlineDoctorId);
                        onlineDoctorId.innerHTML = "<span data-toggle='tooltip' title='Online Doctors'>&#171;</span>";  
                        onlineDoctorId.onclick = function(){
                            $rootScope.callOnlineDoctor();
                        }
                    }else{
                        let removeOnlienDoctor = document.getElementsByClassName('onlineDoctorClass')[0];
                        if(removeOnlienDoctor) removeOnlienDoctor.parentNode.removeChild(removeOnlienDoctor);
                    }
                }
                console.log(result);
            })
        }
        /* login controller end*/
        
        $rootScope.callOnlineDoctor = function(){
            let waitingname = 1;
            var compiledHTML = $compile("<onlinedoctortemplate   name = \"'"+waitingname+"'\"  ></chattemplate>")($scope); //<div chattemplate></div>
            $('#contentBlock').append(compiledHTML);
            
        }
        /*added on 230818*/
        var checkNetworkCallback = function(role,callbackNetworkCheck){

                doctorServices.sessiontokenapikey()
                .then(function(result){
                    if(result.data.status_code == 200){
                        $scope.OT_network_session = result.data.result.session;
                        $scope.OT_network_token = result.data.result.token;
                        /*ab---temp var to forward session token to plivo---(280718)*/
                        $rootScope.toPlivoSessId = $scope.OT_network_session;
                        $rootScope.toPlivoToken = $scope.OT_network_token;
                        /*----------------------------------------*/
                        var el = document.createElement("div");el.classList.add('OT_Network_Class_div');let el_img = document.createElement("img");let el_p = document.createElement("p");el_p.innerHTML = "Checking Your Network...please wait!";el_img.src = "./otnetwork/assets/spinner.gif";
                        var el_span =  document.createElement("span");
                        el_span.innerHTML = "&times"; el_span.onclick = function(){ el.parentNode.removeChild(el); session.disconnect(); }
                        el.appendChild(el_span);el.appendChild(el_img);el.appendChild(el_p);document.body.appendChild(el);
                        var session = OT.initSession(config.opentokAPIKey,$scope.OT_network_session);

                        callbackInitPublisher(role,function(callback1){

                            

                            var ot_piblisher = document.querySelector('.OT_publisher');
                            if(ot_piblisher != undefined){
                                
                                //ot_piblisher.style.display = 'none';
                                ot_piblisher.style.position = 'absolute';//ot_piblisher.style.zIndex = '9999';//ot_piblisher.style.top = '10%';//ot_piblisher.style.left = '0px';
                            }
                            if(callback1.a == 1){
                                callbackConnectSession(session,$scope.OT_network_token,function(callback2){
                                    console.log(session);
                                    if(callback2.b == 1){
                                        callbackPublishSession(session,callback1.publisher,function(callback3){
                                            console.log(callback1.publisher);
                                            if(callback3.c == 1){
                                                callbackSubscribeSession(session,callback1.publisher.stream,function(callback4){
                                                    if(callback4.d == 1){
                                                        testStreamingCapability(callback4.subscriber, function(error, message) {
                                                            var ot_piblisher = document.querySelector('.OT_publisher');
                                                            ot_piblisher.style.display = 'none';
                                                            if(!error){
                                                                if(message.code == 2001){
                                                                    $scope.isDeviceNotAvailable = 0;
                                                                    el.parentNode.removeChild(el);
                                                                    session.disconnect();
                                                                    callbackNetworkCheck({acode:1});
                                                                }else{
                                                                    el.parentNode.removeChild(el);
                                                                    session.disconnect();
                                                                    callbackNetworkCheck({acode:0});
                                                                }
                                                            }else{
                                                                el.parentNode.removeChild(el);
                                                                session.disconnect();
                                                                callbackNetworkCheck({acode:0});
                                                            }
                                                        });
                                                    }
                                                })
                                            }
                                        })
                                    }        
                                })
                            }else{
                                callbackNetworkCheck({acode:2});
                                el.parentNode.removeChild(el);
                                var modalInstance = $uibModal.open({
                                    template:    '<div class="modal-header bootstrap-modal-header">\
                                                    <h3 class="modal-title" id="modal-title">Network Check </h3>\
                                                    </div>\
                                                    <div class="modal-body bootstrap-modal-body" id="modal-body">\
                                                    <p> Sorry, No Video Device Found</p>\
                                                    </div>\
                                                    <div class="modal-footer bootstrap-modal-footer">\
                                                        <button class="btn btn-primary" type="button" ng-click="cancel()">OK</button>\
                                                    </div>\
                                                    ',
                                    controller: ModalInstanceCtrl,
                                    scope: $scope,
                                    size:'sm',
                                    windowClass: 'sendpatient-email-pop-class',
                                    resolve: {
                                        modalProgressValue: function () {
                                        return "";
                                        },
                                        CPTBilling : function(){
                                            return "";
                                        },
                                        sessionResolve : function(){
                                            return '';
                                        },
                                        meetingRoomURLResolve : function(){
                                            return "";
                                        },
                                        emailMeetingLinkUrlResolve : function(){
                                            return '';
                                        },
                                        lockEncounterData : function(){
                                            return "";
                                        },
                                        disconnectData : function(){
                                            return "";
                                        }
                                    }
                
                                });
                                modalInstance.result.then(function (selectedItem) {
                                    $scope.selected = selectedItem;
                                    }, function () {
                                    $log.info('Modal dismissed at: ' + new Date());
                                });
                            }
                        })
                    }
                })
                
            }

            $scope.checkNetwork = function () {
            debugger
            checkNetworkCallback('pcpDoctor', function (result) {
                debugger
                if (result.acode == 1) {
                    var modalInstance = $uibModal.open({
                        template: '<div class="modal-header bootstrap-modal-header">\
                                            <h3 class="modal-title" id="modal-title">Pre-Call Test</h3>\
                                            </div>\
                                            <div class="modal-body bootstrap-modal-body" id="modal-body">\
                                            <p>Great! You have everything in place and you are all set to go.</p>\
                                            </div>\
                                            <div class="modal-footer bootstrap-modal-footer">\
                                                <button class="btn btn-primary" type="button" ng-click="cancel()">OK</button>\
                                            </div>\
                                            ',
                        controller: ModalInstanceCtrl,
                        scope: $scope,
                        size: 'sm',
                        windowClass: 'sendpatient-email-pop-class',
                        resolve: {
                            modalProgressValue: function () {
                                return "";
                            },
                            CPTBilling: function () {
                                return "";
                            },
                            sessionResolve: function () {
                                return '';
                            },
                            meetingRoomURLResolve: function () {
                                return "";
                            },
                            emailMeetingLinkUrlResolve: function () {
                                return '';
                            },
                            lockEncounterData: function () {
                                return "";
                            },
                            disconnectData: function () {
                                return "";
                            }
                        }

                    });
                    modalInstance.result.then(function (selectedItem) {
                        $scope.selected = selectedItem;
                    }, function () {
                        $log.info('Modal dismissed at: ' + new Date());
                    });
                } else if (result.acode == 0) {
                    var modalInstance = $uibModal.open({
                        template: '<div class="modal-header bootstrap-modal-header">\
                                            <h3 class="modal-title" id="modal-title">Weak Signal </h3>\
                                            </div>\
                                            <div class="modal-body bootstrap-modal-body" id="modal-body">\
                                            <p>Unfortunately, your current signal strength will neither support a video nor an audio call.  Please try again from a different area with stronger signal.</p>\
                                            </div>\
                                            <div class="modal-footer bootstrap-modal-footer">\
                                                <button class="btn btn-primary" type="button" ng-click="cancel()">OK</button>\
                                            </div>\
                                            ',
                        controller: ModalInstanceCtrl,
                        scope: $scope,
                        size: 'sm',
                        windowClass: 'sendpatient-email-pop-class',
                        resolve: {
                            modalProgressValue: function () {
                                return "";
                            },
                            CPTBilling: function () {
                                return "";
                            },
                            sessionResolve: function () {
                                return '';
                            },
                            meetingRoomURLResolve: function () {
                                return "";
                            },
                            emailMeetingLinkUrlResolve: function () {
                                return '';
                            },
                            lockEncounterData: function () {
                                return "";
                            },
                            disconnectData: function () {
                                return "";
                            }
                        }

                    });
                    modalInstance.result.then(function (selectedItem) {
                        $scope.selected = selectedItem;
                    }, function () {
                        $log.info('Modal dismissed at: ' + new Date());
                    });

                } else {
                    return false;
                }
            })

        }
        /*--------------*/
        
        /* index controller start */
        // if(JSON.parse(localStorage.getItem('connect_provider_settings')) != undefined && JSON.parse(localStorage.getItem('connect_provider_settings')).type == "WC_NURSE"){
        //     $scope.onlineDoctorAvailable = 1;
        //     var waitingname = 12;
        //     var onlineDoctorId =   document.createElement('div');
        //     alert(1);
	       // onlineDoctorId.classList.add('onlineDoctorClass');
	       // document.querySelector('#contentBlock').appendChild(onlineDoctorId);
	       // $log.log(onlineDoctorId);
	       // onlineDoctorId.innerHTML = "<button>this is funny </button>";
	       // onlineDoctorId.onclick = function(){
	       //     alert(1);
	       // }
        //     var compiledeHTML = $compile("<onlinedoctortemplate   name = \"'"+waitingname+"'\"  ></chattemplate>")($scope); //<div chattemplate></div>
	        
        // }else{
        //     $scope.onlineDoctorAvailable = 0;
        //}
        
        
        
        /* index controller end */
        
        /* doctor dashboard controller */
        if(localStorage.getItem('doc_token') && $state.current.name == 'doctor'){
            $rootScope.chatOn = 0;
            $rootScope.title = "Dashboard"; 
            $scope.docData = JSON.parse(localStorage.getItem('pcpDocData'));
			$scope.getClass = function (data) {
                $("li#" + data + " i").css('pointer-events', 'none');
                $("li#" + data).css('cursor', 'not-allowed');
                $("li#" + data).attr("title", "Already on another Call");
            }  
			
			//added on 070818
			$rootScope.$on('grouproomalias', function (event, data) {
              var data = JSON.parse(localStorage.getItem('pcpDocData'));
              data.room = data.room_alias;
              $scope.docData = data ;

            });
            // setInterval(function(){
            //     $scope.getWaitingUserList();
            // }, 30000);
            //msg x
            //userid y
            //docid z
            $scope.chatRoom = [];
            socketService.on('chatSend', function(data){
                console.log(data);
                if($('chattemplate').attr('id') != data.senderid){
                    $scope.param ={};
                    var firstName = data.sendername.split(' ').slice(0, -1).join(' ');
                    var lastName = data.sendername.split(' ').slice(-1).join(' ');
                    $scope.param.patient_id = data.senderid;
                    $scope.param.first_name = firstName;
                    $scope.param.last_name = lastName;
                    $scope.param.msg = data.text;
                    $scope.param.pcp_doctor_id = data.id;
                    $scope.openChat($scope.param); 
                }else{
                    
                }    
            });
            $scope.isDeviceNotAvailable = 1;
            
            

            
            
            $scope.openChat = function(x){
                // if($('chattemplate').length > 0){
                //     $('.chatBox').addClass('chatBoxRight');
                // }
                //var index = $scope.chatRoom.indexOf(x.patient_id); 
                if ($scope.docData.id == x.pcp_doctor_id) {
                    
                    var index = $scope.chatRoom.indexOf(x.patient_id);
                    if (index == -1) {

                        if (x.msg != undefined && x.msg != '') {
                            $scope.text = x.msg;
                        } else {
                            $scope.text = '';
                        }
                        $scope.chatRoom.push(x.patient_id);
                        if ($scope.chatRoom.length > 2)
                            $rootScope.chatOff($scope.chatRoom[0]);
                        var waitingname = x.first_name + ' ' + x.last_name;
                        var compiledeHTML = $compile("<chattemplate  sendertext = \"'" + $scope.text + "'\"   datatemplateid = " + x.patient_id + "  sendername = \"'" + $scope.docData.name + "'\" senderid = '" + $scope.docData.id + "' sender = \"'doctor'\"     id = " + x.patient_id + " name = \"'" + waitingname + "'\"  ></chattemplate>")($scope); //<div chattemplate></div>
                        if ($scope.chatRoom.length > 1) {
                            //$('#chatBox')[$scope.chatRoom.length-1].style.right = '318px'
                            document.getElementsByClassName('chatBox')[0].style.right = '300px';
                            //document.getElementsByClassName('span')[0].style.right = '318px';
                            // $('span')[0].style.right='311px'
                           // $('#chatclosebutton')[0].style.right = '311px';

                        }
                        $('#chatRoom').append(compiledeHTML);
                        $("#chatBody_" + x.patient_id).html('');
                        //$rootScope.chatOn = 1;

                        $scope.chatWaitingId = x.patient_id;
                        $scope.chatterName = x.first_name + ' ' + x.last_name;
                    }
                }
            }
            $rootScope.chatOff = function(x){
                console.log($scope.chatRoom);
                $("chattemplate#"+x+" .chatBox").remove();
                             
               
               // $("chattemplate#"+x).remove();
                var index = $scope.chatRoom.indexOf(x);
                $scope.chatRoom.splice(index,1);
                if ($scope.chatRoom.length == 1) {
                    document.getElementsByClassName('chatBox')[0].style.right = '0px';
                   // $('#chatclosebutton')[0].style.right = '11px'

                }
            }
            $scope.getWaitingUserList = function(){
                $scope.param = {};
                $scope.param.id = $scope.docData.id;
                $scope.param.group_id = $scope.docData.group_id;
                doctorServices.getWaitingUserList($scope.param)
                .then(function(result){
                    if(result.data.status_code == 200){
                        $scope.userWaitingList = result.data.result;
                    }else{
                        alert(error);
                    }
                })
            }
            $scope.getWaitingUserList();
            
             var stop = $interval(function() {
               $scope.getWaitingUserList();
           }, 3000);
           $rootScope.$on('logout_sropinterval', function (event, data) {
               $interval.cancel(stop);

           });


            socketService.on('doctorAcceptedCall',function(data){
            	$("li#"+data.patientId+" i").css('pointer-events','none');
                $("li#"+data.patientId).css('cursor','not-allowed');
                $("li#"+data.patientId).attr("title","Already on another Call");

            })

            //$scope.userWaitingList = [];
            socketService.on('userjoin', function(waitingId){
                console.log('11111111');
                $('body').after('<audio controls autoplay  style="display: none;"><source src="'+$scope.clientURL+'/assets/audio/notification48.mp3" type="audio/mp3"></audio>');
                $scope.waitingParam = {};
                $scope.waitingParam.pcp_doctor_id = $scope.docData.id;
                $scope.waitingParam.patient_id = waitingId;
                $scope.waitingParam.group_id = $rootScope.docData.group_id;
                doctorServices.getWaitingUserListFromUserId($scope.waitingParam)
                .then(function(result){
                    if(result.data.status_code == 200 && result.data.result.length > 0){

                        if($scope.userWaitingList.length == 0){
                            
                            $scope.userWaitingList.push(result.data.result[0]); 
                            }else{
                                for(var i=0;i<$scope.userWaitingList.length;i++){
                                    if($scope.userWaitingList[i].patient_id != result.data.result[0].patient_id){
                                        $scope.userWaitingList.push(result.data.result[0]); 
                                        toastr.info( result.data.result[0].first_name+ ' has checked In');    
                                    }else{

                                        var index = $scope.userWaitingList.indexOf(result.data.result[0].patient_id);
                                        $scope.userWaitingList.splice(index,1);
                                        console.log($scope.userWaitingList);

                                        $scope.userWaitingList.push(result.data.result[0]);
                                    }
                                }        
                            }
                            
                        
                        // var index = $scope.userWaitingList[0].indexOf(result.data.result[0].id);
                     //    alert(index);
                        
                        // if(index == -1){
                        //  $scope.userWaitingList.push(result.data.result[0]); 
                        //  toastr.info( result.data.result[0].first_name+ ' has checked In');
                        // }else{
                        //  $scope.userWaitingList.splice(index,1);
                        //  $scope.userWaitingList.push(result.data.result[0]); 
                        //  //toastr.info( result.data.result[0].first_name+ ' has checked In');
                        // }
                    }else{
                            //alert("error");
                        }
                    
                    });    
            });

            // socketService.on('userleft', function(data){

            //     if($scope.userWaitingList.length >= 1){
            //         toastr.info(data.name+ ' has left');
            //         var index = $scope.userWaitingList.indexOf(data.waitingId);
            //         if(index == -1){
            //             $scope.userWaitingList.splice(index,1);
            //         }    
            //     }




            //     });

            
            
            if($scope.docData.room_alias != ''){
                $scope.docData.room = $scope.docData.room_alias;
            }
            
            
            $scope.editDocRoomAlias = function(){
                $scope.isToggled = 1;
            }
            $scope.saveDocRoomAlias = function(alias,docId){
                if(alias == ''){
                    alert("error");
                    return false;
                }
                $scope.loading = true;
                $scope.param = {};
                $scope.param.id = docId;
                $scope.param.room_alias = alias;
                doctorServices.updateDocRoomAlias($scope.param)
                .then(function(result){
                    if(result.data.status_code == 200){
                        $scope.loading = false;
                        $scope.docData = JSON.parse(localStorage.getItem('pcpDocData'));
                        $scope.docData.room_alias = alias;
                        localStorage.setItem('pcpDocData',JSON.stringify($scope.docData));
                        $scope.docData = JSON.parse(localStorage.getItem('pcpDocData'));
                        $scope.docData.room = $scope.docData.room_alias;
                        $scope.isToggled = 0;
                    }else{
                        $scope.loading = false;
                        alert("error");
                        return false;
                    }
                    });
            }
            $scope.canceltDocRoomAlias = function(){
                $scope.isToggled = 0;   
            }

			
			$scope.inviteOtherFriendMeeting = function(email,link){
				
				alert(email);
		
        $scope.loading = true;
        $scope.param = {};
        $scope.param.patientEmail = email;
        $scope.param.docMeetingEmailLink = link;
        doctorServices.sendEmailMeetingLink($scope.param)
        .then(function(result){
            if(result.data.status_code == 200){
                $scope.loading = false;
                $uibModalInstance.dismiss('cancel');
                toastr.success('Email sent successfully');
            }else{
                alert("error");
            }
            })
    }

    $scope.inviteOtherFriendMeetingSMS = function(phone,link){
        $scope.loading = true;
        $scope.param = {};
        $scope.param.patientPhone = phone;
        $scope.param.docMeetingSMSLink = link;
        doctorServices.sendSMSMeetingLink($scope.param)
        .then(function(result){
            if(result.data.status_code == 200){
                $scope.loading = false;
                $uibModalInstance.dismiss('cancel');
                toastr.success('SMS sent successfully');
            }else{
                alert("error");
            }
            })
    }

			
			
			
            $scope.sendMeetingUrlPatient = function(){
                var modalInstance = $uibModal.open({
                    templateUrl: "sendEmailToPatientPopup.html",
                    controller: ModalInstanceCtrl,
                    scope: $scope,
                    size:'sm',
                    windowClass: 'sendpatient-email-pop-class',
                    resolve: {
                        modalProgressValue: function () {
                        return "";
                        },
                        CPTBilling : function(){
                            return "";
                        },
                        sessionResolve : function(){
                            return $scope.disconnectedData;
                        },
                        meetingRoomURLResolve : function(){
                            return "";
                        },
                        emailMeetingLinkUrlResolve : function(){
                            return $scope.clientURL+"/#!/room/"+$rootScope.docData.room_alias;
                        },
                        lockEncounterData : function(){
                            return "";
                        },
                        disconnectData : function(){
                            return "";
                        }
                    }

                });
                modalInstance.result.then(function (selectedItem) {
                    $scope.selected = selectedItem;
                    }, function () {
                    $log.info('Modal dismissed at: ' + new Date());
                });

            }

            $scope.SMSMeetingUrlPatient = function(){
                var modalInstance = $uibModal.open({
                    templateUrl: "sendSMSToPatientPopup.html",
                    controller: ModalInstanceCtrl,
                    scope: $scope,
                    size:'sm',
                    windowClass: 'sendpatient-email-pop-class',
                    resolve: {
                        modalProgressValue: function () {
                        return "";
                        },
                        CPTBilling : function(){
                            return "";
                        },
                        sessionResolve : function(){
                            return $scope.disconnectedData;
                        },
                        meetingRoomURLResolve : function(){
                            return "";
                        },
                        emailMeetingLinkUrlResolve : function(){
                            return $scope.clientURL+"/#!/room/"+$rootScope.docData.room_alias;
                        },
                        lockEncounterData : function(){
                            return "";
                        },
                        disconnectData : function(){
                            return "";
                        }
                    }

                });
                modalInstance.result.then(function (selectedItem) {
                    $scope.selected = selectedItem;
                    }, function () {
                    $log.info('Modal dismissed at: ' + new Date());
                });

            }



            /*added on 110818---------------------*/
            $scope.deleteUserInWating = function (callid,index) {
                $scope.itemindex = index;
                var modalInstance = $uibModal.open({
                    template: '<div class="modal-header bootstrap-modal-header">\
                                            <h3 class="modal-title" id="modal-title"> Confirm removal from the waiting room! </h3>\
                                            </div>\
                                            <div class="modal-body bootstrap-modal-body" id="modal-body">\
                                            <p>Are you sure you want to remove this entry from the waiting room? You will no longer be able to initiate a video chat with this person.</p>\
                                            </div>\
                                            <div class="modal-footer bootstrap-modal-footer">\
                                            <button class= "btn btn-primary" type="button" ng-click="confirmdelete('+ callid +')">Yes</button>\
                                            <button class="btn btn-primary" type="button" ng-click="cancel()">No</button>\
                                            </div>\
                                            ',
                    controller: ModalInstanceCtrl,
                    scope: $scope,
                    size: 'sm',
                    windowClass: 'sendpatient-email-pop-class',
                    resolve: {
                        modalProgressValue: function () {
                            return "";
                        },
                        CPTBilling: function () {
                            return "";
                        },
                        sessionResolve: function () {
                            return '';
                        },
                        meetingRoomURLResolve: function () {
                            return "";
                        },
                        emailMeetingLinkUrlResolve: function () {
                            return '';
                        },
                        lockEncounterData: function () {
                            return "";
                        },
                        disconnectData: function () {
                            return "";
                        }
                    }

                });
                modalInstance.result.then(function (selectedItem) {
                    $scope.selected = selectedItem;
                }, function () {
                    $log.info('Modal dismissed at: ' + new Date());
                });


            }
            /*------------------------------------*/
            

            $scope.docCall = function(x,callid){
                checkNetworkCallback('pcpDoctor',function(result){
                    if(result.acode == 1){
                        doctorServices.saveCallStartedAt(new Date());
                        doctorServices.saveWaitingUserId(x);
                        $state.go('doctor.call');
						//added on 040818
						 doctorServices.updatestatusBycallId({ call_id: callid, status: "In progress" })
                            .then(function (result) {
                                $log.log(result);
                                if (result.data.status_code == 200) {
                                    debugger
                                }
                            })

                        socketService.emit('doctorAcceptedCall',{patientId:x},function(data){
                            $log.log("doctor accepted the call");    
                        });
                    }else if(result.acode == 0){
                        var modalInstance = $uibModal.open({
                            template:    '<div class="modal-header bootstrap-modal-header">\
                                            <h3 class="modal-title" id="modal-title">Weak Signal </h3>\
                                            </div>\
                                            <div class="modal-body bootstrap-modal-body" id="modal-body">\
                                            <p>Unfortunately, your current signal strength will neither support a video nor an audio call.  Please try again from a different area with stronger signal.</p>\
                                            </div>\
                                            <div class="modal-footer bootstrap-modal-footer">\
                                                <button class="btn btn-primary" type="button" ng-click="cancel()">OK</button>\
                                            </div>\
                                            ',
                            controller: ModalInstanceCtrl,
                            scope: $scope,
                            size:'sm',
                            windowClass: 'sendpatient-email-pop-class',
                            resolve: {
                                modalProgressValue: function () {
                                return "";
                                },
                                CPTBilling : function(){
                                    return "";
                                },
                                sessionResolve : function(){
                                    return '';
                                },
                                meetingRoomURLResolve : function(){
                                    return "";
                                },
                                emailMeetingLinkUrlResolve : function(){
                                    return '';
                                },
                                lockEncounterData : function(){
                                    return "";
                                },
                                disconnectData : function(){
                                    return "";
                                }
                            }
        
                        });
                        modalInstance.result.then(function (selectedItem) {
                            $scope.selected = selectedItem;
                            }, function () {
                            $log.info('Modal dismissed at: ' + new Date());
                        });
                        
                    }else{
                        return false;
                    }
                })
            }
        }
        /* doctor dashboard controller end*/ 


        /* doctor patient charting controller start */
        if(localStorage.getItem('doc_token') && $state.current.name == 'charting'){
            $rootScope.title = "Charting";
            
            $scope.progressArray = {};
            $scope.CPTArray = [];
            $scope.addeddiagnosisArray = [];
            $scope.patientLogData =doctorServices.getPatientCallLog();

            $log.log($scope.patientLogData);

            if($scope.patientLogData.doctor_instruction != ''){
               $scope.progressArray = JSON.parse($scope.patientLogData.doctor_instruction);
               $scope.progressArray = $scope.progressArray.doctor_instruction;
               $scope.CPTArray = $scope.progressArray.az_cpt_code;
               $scope.addeddiagnosisArray = $scope.progressArray.diagnosticAssesment;

               
            }
            if($scope.patientLogData != undefined){
                if($scope.patientLogData.allergies != '')$scope.patientLogData.allergies = JSON.parse($scope.patientLogData.allergies);

                if($scope.patientLogData.medical_conditions != '')$scope.patientLogData.medical_conditions = JSON.parse($scope.patientLogData.medical_conditions);
                
                if($scope.patientLogData.medications != '')$scope.patientLogData.medications = JSON.parse($scope.patientLogData.medications);

                if($scope.patientLogData.symptoms != ''){
                    $scope.patientLogData.symptoms =   JSON.parse($scope.patientLogData.symptoms);    
                }else{
                    $scope.patientLogData.symptoms =   '';    
                }
            }
        }

        /* doctor patient charting controller end */

        /* wcNurse dashboard controller start */
        if($state.current.name == 'wcNurse'){
        	$log.log($state.params);
        	$scope.loading= true;
        	doctorServices.getUserPassProvider($state.params.token)
        	.then(function(result){
        		$log.log(result);
        		if(result.data.status_code == 200){
        			$scope.loginParams = {};
        			$scope.loginParams.email = result.data.result[0].email;
        			$scope.loginParams.password = result.data.result[0].password;
        			$scope.loginForm($scope.loginParams);	

        			// doctorServices.doctorLogin($scope.loginData)
		         //    .then(function(result){
		         //    	if(result.data.status_code == 200){
		         //    		$scope.loading = false;
		         //    		localStorage.setItem('doc_token',result.data.result.token);
		         //            localStorage.setItem('pcpDocData',JSON.stringify(result.data.result));
		         //            $rootScope.docData = JSON.parse(localStorage.getItem('pcpDocData'));//$cookieStore.get('pcpDocData')
		         //            tokenValidatorService.setDocAuthToken(result.data.result.token); 

		         //            if($rootScope.docData.group_id == 0){
		         //               if($rootScope.docData.room_alias != ''){
		         //                    $scope.connectProviderSettingParam = $rootScope.docData.room_alias;
		         //                    $rootScope.docData.room = $rootScope.docData.room_alias;
		         //                    $scope.getProviderSettingScope($scope.connectProviderSettingParam);
		         //                }else{
		         //                    $scope.connectProviderSettingParam = $rootScope.docData.room;
		         //                    $scope.getProviderSettingScope($scope.connectProviderSettingParam);
		         //                } 
		         //            }else{
		         //                doctorServices.getRoomFromGroupId($rootScope.docData.group_id)
		         //                .then(function(result){
		         //                    if(result.data.status_code == 200){
		         //                        //$scope.universalRoom = result.data.result[0].room;        
		         //                        $rootScope.docData.room_alias = result.data.result[0].room;
		         //                        var data = JSON.parse(localStorage.getItem('pcpDocData'));
		         //                        data.room_alias = result.data.result[0].room;
		         //                        localStorage.setItem('pcpDocData', JSON.stringify(data));
		         //                        $scope.getProviderSettingScope(result.data.result[0].room);
		         //                    }else{
		         //                        alert("error");
		         //                    }
		         //                });
		         //            }

		         //    	}
		         //    })
		        }
        	})
        }else{
        	//$location.path('/');
        }
        /* wcNurse dashboard controller end */


        

        /* doctor call log controller start */
        if(localStorage.getItem('doc_token') && $state.current.name == 'callLog'){
            $scope.loading = true;
            $rootScope.title = "Call Log";
            if(JSON.parse(localStorage.getItem('connect_provider_settings')) != undefined && JSON.parse(localStorage.getItem('connect_provider_settings')).type == "WC_NURSE"){
                $scope.isWCStaffCallLog = true;
            }else{
                $scope.isWCStaffCallLog = false;
            }
            $scope.viewWCStaffLog = function(x){
                if(x.doctor_instruction != '' && JSON.parse(x.doctor_instruction).doctor_instruction.nurseNotes != undefined){
                    $scope.nurseNotes =  JSON.parse(x.doctor_instruction).doctor_instruction.nurseNotes;   
                }else{
                    $scope.nurseNotes = "No Notes";
                }
                var modalInstance = $uibModal.open({
                    template:'\
                        <div class="modal-header bootstrap-modal-header">\
                        <h3 class="modal-title" id="modal-title">Nurse Instruction </h3>\
                        </div>\
                        <div class="modal-body bootstrap-modal-body" id="modal-body">\
                        <p> '+$scope.nurseNotes+'</p>\
                        </div>\
                        <div class="modal-footer bootstrap-modal-footer">\
                            <button class="btn btn-primary" type="button" ng-click="cancel()">OK</button>\
                        </div>\
                        ',
                    controller: ModalInstanceCtrl,
                    scope: $scope,
                    size:'sm',
                    windowClass: 'disconnect-pop1-class',
                    resolve: {
                        modalProgressValue: function () {
                        return "";
                        },
                        CPTBilling : function(){
                            return "";
                        },
                        sessionResolve : function(){
                            return $scope.disconnectedData;
                        },
                        meetingRoomURLResolve : function(){
                            return "";
                        },
                        emailMeetingLinkUrlResolve : function(){
                            return "";
                        },
                        lockEncounterData : function(){
                            return "";
                        },
                        disconnectData : function(){
                            return "";
                        }
                    }

                });
                modalInstance.result.then(function (selectedItem) {
                    $scope.selected = selectedItem;
                    }, function () {
                    $log.info('Modal dismissed at: ' + new Date());
                }); 

            }
            
            $scope.param = {};
            $scope.param.pcp_doctor_id = JSON.parse(localStorage.getItem('pcpDocData')).id;
            doctorServices.getDocCallLogData(JSON.parse(localStorage.getItem('pcpDocData')).id)
            .then(function(result){
                if(result.data.status_code == 200){
                    $scope.loading = false;
                    $scope.callLogData = result.data.result;

                    for(var i=0; i<$scope.callLogData.length;i++){
                        var callstarted = result.data.result[i].call_started;
                        var callended = result.data.result[i].call_ended;
                        var callstarted = moment(callstarted);
                        var callended = moment(callended);
                        var callstarted=moment(callstarted, "HH:mm:ss");
                        var callended=moment(callended, "HH:mm:ss");
                        var duration = moment.duration(callended.diff(callstarted)); 
                        var hours = parseInt(duration.asHours());   if(hours.toString().length == 1){ hours = '0'+hours;}
                        var minutes = parseInt(duration.asMinutes())-hours*60;  if(minutes.toString().length == 1) {minutes = '0'+minutes;}
                        var seconds = parseInt(duration._data.seconds);  if(seconds.toString().length == 1) {seconds = '0'+seconds;}
                        $scope.callLogData[i].call_duration = minutes+' min '+seconds + ' sec';
                    }
                }else{
                    $scope.loading = false;
                    alert("error");
                }
            })

            $scope.savePatientCallLogData = function(x){
                doctorServices.savePatientCallLog(x); 
            }
        }

        /* doctor call log controller send */



        /* doctor call controller start*/     
        if(localStorage.getItem('doc_token') && $state.current.name == 'doctor.call'){
            if(JSON.parse(localStorage.getItem('connect_provider_settings')) != undefined && JSON.parse(localStorage.getItem('connect_provider_settings')).type == 'WC_NURSE'){
                $scope.isWCStaff = true;
            }else{
                $scope.isWCStaff = false;
            }



            $("#lockBTN0").prop("disabled",true);
            $("#lockBTN1").prop("disabled",true);
            //$("#lockBTN2").hide();
            socketService.on('otheruserjoin', function(name){
                toastr.info( name.otherUserName+ ' has checked In');

            });
                
            
            $scope.waitingParam = {};
            $scope.waitingParam.pcp_doctor_id = $scope.docData.id;
            $scope.waitingParam.patient_id = doctorServices.fetchWaitingUserId(); 
            $scope.waitingParam.group_id = $rootScope.docData.group_id;
            doctorServices.getWaitingUserListFromUserId($scope.waitingParam)
            .then(function(result){
                if(result.data.status_code == 200){
                    $scope.userCallData = result.data.result[0];
                    $scope.userCallData.pcp_medication = JSON.parse($scope.userCallData.pcp_medication);
                    $scope.userCallData.pcp_allergy = JSON.parse($scope.userCallData.pcp_allergy);
                    $scope.userCallData.pcp_medical_condition = JSON.parse($scope.userCallData.pcp_medical_condition);
                    $scope.userCallData.pcp_symptom = JSON.parse($scope.userCallData.pcp_symptom);    
                    if($scope.userCallData.pcp_symptom.length == 0){
                       $scope.userCallData.pcp_symptom = ["No Symptom"]; 
                    }
                    $log.log($scope.userCallData);
                }
                });

            

            $scope.oneAtATime = true;    

            // $scope.dynamicOTLayout = function(children){
            //     max slot = 3, width, height, rows
            //     rows = (children % 3 == 0 ) ? (children / 3) : ((children / 3) + 1)
                
            //     width = width / rows, height = height / rows
            // }
            
            
            

            $rootScope.title = "Doctor Live Call";
            $scope.waitingUserId = doctorServices.fetchWaitingUserId();
            $scope.param = {};
            $scope.param.id = $scope.waitingUserId;
            doctorServices.getUserCallDetails($scope.param)
            .then(function(result){
                if(result.data.status_code == 200){
                    $scope.userCallDetails = result.data.result[0];
                    $scope.inviteTableData = {};
                    $scope.inviteTableData.session = result.data.result[0].session;
                    $scope.inviteTableData.token = result.data.result[0].token;
                    
					var waitingname = $scope.userCallDetails.first_name + ' ' + $scope.userCallDetails.last_name
                   var compiledeHTML = $compile("<chattemplate  datatemplateid = " + $scope.userCallDetails.patient_id + " sendername = \"'" + $scope.docData.name + "'\" senderid = '" + $scope.docData.id + "' sender = \"'doctor'\" id = " + $scope.userCallDetails.patient_id + " name = \"'" + waitingname + "'\"  ></chattemplate>")($scope);
                   $('#chatRoom').append(compiledeHTML);

					
                    var session = OT.initSession(config.opentokAPIKey,$scope.userCallDetails.session);

                    $rootScope.pcpDoctorOpentokSession = session;

                    if(!!session){
                        doctorServices.startCallArchive($scope.userCallDetails.session)
                        .then(function(result){
                            $log.log(result);
                            $log.log(123);
                            if(result.data.status_code == 200){
                                doctorServices.setDocArchiveId(result.data.result);

                            }
                        })
												 /*added on 300718*/
                    $("#header-navbar-dash").css("pointer-events", 'none');
                    $("#header-navbar-calllog").css("pointer-events", 'none');
                    $("#header-navbar-preCallTest").css("pointer-events", 'none');
                    }
                    var subscriber,publisher;
                    var OTmaxslot = 3, OTwidth, OTheight, OTrows, OT100Width = 100, OT100Height = 100, OTXaxis,OTYaxis;
                    $scope.isDocPublishVideo = 1;
                    $scope.isDocPublishAudio = 1;
                    // session.on('streamCreated', function(event) {
                    //     session.subscribe(event.stream, 'subscriber', {
                    //                 insertMode: 'append',
                    //                 width: '100%',
                    //                 height: '100%'
                    //             });
                    //     });
                    
                    $scope.docPublisher = JSON.parse(localStorage.getItem('pcpDocData')).name;  
                    var layoutEl = document.getElementById("layout");
                    var layout;
                    $scope.layout = {};
                    $scope.layout.animate = {};
                    $scope.layout.animate.duration = 200; 
                    $scope.layout.animate.easing = 'swing';
                    $scope.layout.maxRatio= 3/2;
                    $scope.layout.minRatio= 9/16;
                    $scope.layout.fixedRatio= false;
                    $scope.layout.animate= false;
                    $scope.layout.bigClass= 'OT_big';
                    $scope.layout.bigPercentage= 0.8;
                    $scope.layout.bigFixedRatio= false;
                    $scope.layout.bigMaxRatio= 3/2;
                    $scope.layout.bigMinRatio= 9/16;
                    $scope.layout.bigFirst= true;
                    session.on('streamCreated', function(event) {
                        var el = document.createElement("div");
                        el.classList.add('OT_'+event.stream.streamId);
                        session.subscribe(event.stream,el);
                        layoutEl.appendChild(el);
                        createLayout(layoutEl,$scope.layout);
                        el.onclick = function(){
                            if ($(this).hasClass("OT_big")) {
                                $(this).removeClass("OT_big");
                            } else {
                                $(this).addClass("OT_big");
                            }
                            createLayout(layoutEl,$scope.layout);        
                        }
                    });


                    session.on("streamDestroyed", function(event) {
                        var elem = document.querySelector('.OT_'+event.stream.streamId);
                        elem.parentNode.removeChild(elem);
                        createLayout(layoutEl,$scope.layout);
                    });

                    
                    session.on('sessionDisconnected', function(event) {
                        console.log('You were disconnected from the session.', event.reason);
                    });
                    session.connect($scope.userCallDetails.token, function(error) {
                        var layoutEl = document.getElementById("layout");
                        var layout;
                        $scope.layout = {};
                        $scope.layout.animate = {};
                        $scope.layout.animate.duration = 200; 
                        $scope.layout.animate.easing = 'swing';
                        $scope.layout.maxRatio= 3/2;
                        $scope.layout.minRatio= 9/16;
                        $scope.layout.fixedRatio= false;
                        $scope.layout.animate= false;
                        $scope.layout.bigClass= 'OT_big';
                        $scope.layout.bigPercentage= 0.8;
                        $scope.layout.bigFixedRatio= false;
                        $scope.layout.bigMaxRatio= 3/2;
                        $scope.layout.bigMinRatio= 9/16;
                        $scope.layout.bigFirst= true;
                        var el = document.createElement("div");
                        layoutEl.appendChild(el);
                        createLayout(layoutEl,$scope.layout);
                        if (!error) {
                            var publisherProperties = {name: " "+$scope.docPublisher, width:'100%',height:'100%'};
                            publisher = OT.initPublisher(el,publisherProperties, {
                                resolution: '320x240', 
                                frameRate: 1
                            });
                            session.publish(publisher);  
                        } else {
                            console.log('There was an error connecting to the session: ', error.code, error.message);
                        }
                    });

                    socketService.on('callDisconnectedByDoc', function(data){

                        $scope.disconnectedData = {};
                        $scope.disconnectedData.waitingUserId = $scope.waitingUserId;
                        $scope.disconnectedData.session = session;

                         var modalInstance = $uibModal.open({
                                templateUrl: "CallDisconnectedPatient.html",
                                controller: ModalInstanceCtrl,
                                scope: $scope,
                                size:'sm',
                                windowClass: 'disconnect-pop1-class',
                                resolve: {
                                    modalProgressValue: function () {
                                    return "";
                                    },
                                    CPTBilling : function(){
                                        return "";
                                    },
                                    sessionResolve : function(){
                                        return $scope.disconnectedData;
                                    },
                                    meetingRoomURLResolve : function(){
                                        return "";
                                    },
                                    emailMeetingLinkUrlResolve : function(){
                                        return "";
                                    },
                                    lockEncounterData : function(){
                                        return "";
                                    },
                                    disconnectData : function(){
                                        return "";
                                    }
                                }

                            });
                            modalInstance.result.then(function (selectedItem) {
                                $scope.selected = selectedItem;
                                }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            }); 
                        
                    });


                    $scope.disableDocCallAudio = function(){
                        if($scope.isDocPublishAudio == 1){
                           $scope.isDocPublishAudio = 0; 
                            publisher.publishAudio(false);
                        }else{
                            $scope.isDocPublishAudio = 1;
                            publisher.publishAudio(true);
                        }    
                        $('#addPsuedoContent1 span i').toggleClass('afterContentIcon1');
                    }

                    $scope.disableDocCallVideo = function(){
                        if($scope.isDocPublishVideo == 1){
                           $scope.isDocPublishVideo = 0; 
                            publisher.publishVideo(false);

                        }else{
                            $scope.isDocPublishVideo = 1;
                            publisher.publishVideo(true);
                        }    
                        $('#addPsuedoContent span i').toggleClass('afterContentIcon');
                    }
					
					
					
					    $scope.ppparam = {};
                        $scope.ppparam.session = $scope.userCallDetails.session;
                        
                        $scope.ppparam.token = $scope.userCallDetails.token;
                        doctorServices.getSessionFromInvite($scope.ppparam)
                        .then(function(result){
                            
                            if(result.data.status_code == 200){

                                $scope.ppmeetingBaseUrl = $location.$$absUrl.split('#!');
                                $scope.ppmeetingBaseUrl = $scope.ppmeetingBaseUrl[0];
                                $rootScope.ppmeetingBaseUrl = $scope.ppmeetingBaseUrl+'/#!/room/'+$rootScope.docData.room_alias+'?inviteId='+result.data.result[0].invite_id;
                                
                               doctorServices.setInviteUrl($rootScope.ppmeetingBaseUrl);
                            
                            }else{

                                alert("error");
                            }
                        });


					
					

                    $scope.inviteRoomURL = function(){
                        $scope.loading = true;
                        $scope.param = {};
                        $scope.param.session = $scope.userCallDetails.session;
                        $scope.param.token = $scope.userCallDetails.token;
                        doctorServices.getSessionFromInvite($scope.param)
                        .then(function(result){
                            if(result.data.status_code == 200){
                                $scope.meetingBaseUrl = $location.$$absUrl.split('#!');
                                $scope.meetingBaseUrl = $scope.meetingBaseUrl[0];
                                $scope.meetingBaseUrl = $scope.meetingBaseUrl+'/#!/room/'+$rootScope.docData.room_alias+'?inviteId='+result.data.result[0].invite_id;
                                //$state.go('inviteRoom',{id:$rootScope.docData.room_alias,sessionId:$scope.userCallDetails.session,token:$scope.userCallDetails.token});
								/*added opn 310718*/

                                $scope.loading = false;
                                var modalInstance = $uibModal.open({
                                    templateUrl: "inviteThirdPersonCallDoc.html",
                                    controller: ModalInstanceCtrl,
                                    scope: $scope,
                                    //size:'sm',
                                    windowClass: 'invite-people-pop-class',
                                    resolve: {
                                        modalProgressValue: function () {
                                        return "";
                                        },
                                        CPTBilling : function(){
                                            return "";
                                        },
                                        sessionResolve : function(){
                                            return $scope.disconnectedData;
                                        },
                                        meetingRoomURLResolve : function(){
                                            return $scope.meetingBaseUrl;
                                        },
                                        emailMeetingLinkUrlResolve : function(){
                                            return "";
                                        },
                                        lockEncounterData : function(){
                                            return "";
                                        },
                                        disconnectData : function(){
                                            return "";
                                        }
                                    }

                                });
                                modalInstance.result.then(function (selectedItem) {
                                    $scope.selected = selectedItem;
                                    }, function () {
                                    $log.info('Modal dismissed at: ' + new Date());
                                });
                            }else{
                                $scope.loading = false;
                                alert("error");
                            }

                        })
                    }

                    /*---ab---call recording start stop---(200618)*/
                    $scope.stopRecording = function(){

                        if($('#recordingControl').hasClass('fa fa-pause')){
                                $scope.stopArchiveParameter = {};
                                $scope.stopArchiveParameter.archiveId =doctorServices.getDocArchiveId();
                                doctorServices.stopDoctorCallRecording($scope.stopArchiveParameter.archiveId)
                                .then(function(result){
                                    console.log(result);
                                    if(result.data.status_code==200){
                                        $('#recordingControl').removeClass('fa fa-pause');
                                        $('#recordingControl').addClass('fa fa-play');
                                        console.log('recording stopped');
                                    }
                                $log.log(result);
                                })
                            }
                            else{
                                    if($('#recordingControl').hasClass('fa fa-play'))
                                    {
                                        $scope.waitingUserId = doctorServices.fetchWaitingUserId();
                                        $scope.param = {};
                                        $scope.param.id = $scope.waitingUserId;
                                        doctorServices.getUserCallDetails($scope.param)
                                        .then(function(result){
                                            $scope.userCallDetails = result.data.result[0];


                                            var session = OT.initSession(config.opentokAPIKey,$scope.userCallDetails.session);
                                            if(!!session){
                                            doctorServices.startCallArchive($scope.userCallDetails.session)
                                            .then(function(result){
                                            $log.log(result);
                                            if(result.data.status_code == 200){
                                                $('#recordingControl').removeClass('fa fa-play');
                                                $('#recordingControl').addClass('fa fa-pause');
                                                console.log('recording resumed');
                                            doctorServices.setDocArchiveId(result.data.result);

                                            }
                                            })
                                            }


                                        })
                                    }
                                    else{ console.log('some error in recording start/stop'); }   
                                }

                    }
                /*ab---latest make call function*/
                    $scope.addNewCall = function(){
                        
                         
                    } 

                    $scope.makeCall = function(){
                    
                    var numToDial = $('#numberToDial').val();
                    var roomId = '8767687'; 
                    if(numToDial==''){ return false; }
                    

                    $scope.waitingUserId = doctorServices.fetchWaitingUserId();
                                        $scope.param = {};
                                        $scope.param.id = $scope.waitingUserId;

                     /*doctorServices.getUserCallDetails($scope.param)
                                        .then(function(result){
                             console.log(result);   
							$scope.param1 = {};
							$scope.param1.destNumber = numToDial;
							$scope.param1.roomId = roomId;            
                            var sessionIdTemp = result.data.result[0];
                            $scope.param1.sessionId = sessionIdTemp.session;

                            doctorServices.plivoMakeCall($scope.param1)
                            .then(function(result){
                            console.log(result);
                            });
                                        });*/
                                        doctorServices.sessiontokenapikey()
                                        .then(function(response){                                            console.log(response.data);
                                            $scope.param1 = {};
                                            $scope.param1.destNumber = numToDial;
                                            $scope.param1.roomId = roomId;
                                            $scope.param1.callSessionId = $rootScope.toPlivoSessId;
                                            $scope.param1.token = $rootScope.toPlivoToken;
                                            doctorServices.plivoMakeCall($scope.param1)
                                            .then(function(response){
                                            //console.log(response.data);
                                            if(response.data){
                                                $scope.plivoCallDetails = response.data.result;
                                                console.log('call response----'+$scope.plivoCallDetails);
                                                const session = OT.initSession('45732912', $scope.plivoCallDetails.sessionId);

                                            session.connect($scope.param1.token, function(error) {
                                                if(!error){
                                                   
                                                 var layoutEl = document.getElementById("layout");
                                                var layout;
                                                $scope.layout = {};
                                                $scope.layout.animate = {};
                                                $scope.layout.animate.duration = 200; 
                                                $scope.layout.animate.easing = 'swing';
                                                $scope.layout.maxRatio= 3/2;
                                                $scope.layout.minRatio= 9/16;
                                                $scope.layout.fixedRatio= false;
                                                $scope.layout.animate= false;
                                                $scope.layout.bigClass= 'OT_big';
                                                $scope.layout.bigPercentage= 0.8;
                                                $scope.layout.bigFixedRatio= false;
                                                $scope.layout.bigMaxRatio= 3/2;
                                                $scope.layout.bigMinRatio= 9/16;
                                                $scope.layout.bigFirst= true;
                                                var el = document.createElement("div");
                                                layoutEl.appendChild(el);
                                                createLayout(layoutEl,$scope.layout);
                                                if (!error) {
                                                var publisherProperties = {name: "DR. "+$scope.docPublisher, width:'100%',height:'100%'};
                                                /*publisher = OT.initPublisher(el,publisherProperties, {
                                                resolution: '320x240', 
                                                frameRate: 1
                                                });*/
                                                //session.publish(publisher);  
                                                } else {
                                                console.log('There was an error connecting to the session: ', error.code, error.message);
                                                }

                                                }else{
                                                    alert('error in connection');
                                                }
                                            });

                                                /*const session = OT.initSession('45732912', $scope.plivoCallDetails.sessionId);
                                        session.connect($scope.plivoCallDetails.token, function(error) {
                                        if (!error) {
                                        var publisherProperties = {name:"doctorPublisher"};
                                        var publisher = OT.initPublisher('doctorPublisher',publisherProperties, {
                                        resolution: '320x240', 
                                        frameRate: 1
                                        });
                                        session.publish(publisher);  
                                        }else{
                                        $log.log('There was an error connecting to the session: ', error.code, error.message);
                                        }
                                        });*/

                                               /*var id = Math.floor( Math.random()*999 ) + 100;
                                               

                                               session.subscribe($scope.plivoCallDetails, 'subscriber'+id);
                                            if($('.subscriberClass').length == 1){
                                            $('.subscriberClass').css({"width": "100%", "height": "100%","overflow":"hidden","border":"1px solid #dcdcdc","position":"absolute","left":"0","top":"0","z-index":"10"});
                                            }
                                            if($('.subscriberClass').length > 1){
                                            $("#subscriber"+id).addClass('newSubscriber');
                                            }*/
 
                                /*session.on('streamCreated', function(event) {
                                var streamId = event.stream.streamId;
                                var id = Math.floor( Math.random()*999 ) + 100;
                                $('#subscriber').append("<div class='subscriberClass' id='subscriber"+id+"'> </div>");
                                session.subscribe(event.stream, 'subscriber'+id);
                                if($('.subscriberClass').length == 1){
                                $('.subscriberClass').css({"width": "100%", "height": "100%","overflow":"hidden","border":"1px solid #dcdcdc","position":"absolute","left":"0","top":"0","z-index":"10"});
                                }
                                if($('.subscriberClass').length > 1){
                                $("#subscriber"+id).addClass('newSubscriber');
                                }
                                });*/
                                            /*doctorServices.savePlivoCallDetailsLocalstorage($scope.deleteUserParam);*/
                                            }
                                            });

                                        })

                    
                    }
                    /*--------------------------------------------*/
                    
                    $scope.disconnectSession = function(){

                        $scope.disconnectedData = {};
                        $scope.disconnectedData.waitingUserId = $scope.waitingUserId;
                        $scope.disconnectedData.session = session;
                        
                        var modalInstance = $uibModal.open({
                                templateUrl: "CallDisconnectedPop1.html",
                                controller: ModalInstanceCtrl,
                                scope: $scope,
                                size:'sm',
                                windowClass: 'disconnect-pop1-class',
                                resolve: {
                                    modalProgressValue: function () {
                                    return "";
                                    },
                                    CPTBilling : function(){
                                        return "";
                                    },
                                    sessionResolve : function(){
                                        return $scope.disconnectedData;
                                    },
                                    meetingRoomURLResolve : function(){
                                        return "";
                                    },
                                    emailMeetingLinkUrlResolve : function(){
                                        return "";
                                    },
                                    lockEncounterData : function(){
                                        return "";
                                    },
                                    disconnectData : function(){
                                        return "";
                                    }
                                }

                            });
                            modalInstance.result.then(function (selectedItem) {
                                $scope.selected = selectedItem;
                                }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });    

                    }



                    // $scope.disconnectSession = function(){
                    

                            
                
                    //         var modalInstance = $uibModal.open({
                    //             templateUrl: "CallDisconnectedPop1.html",
                    //             controller: ModalInstanceCtrl,
                    //             scope: $scope,
                    //             size:'sm',
                    //             resolve: {
                    //                 modalProgressValue: function () {
                    //                 return "";
                    //                 },
                    //                 CPTBilling : function(){
                    //                     return "";
                    //                 }
                    //             }

                    //         });
                    //         modalInstance.result.then(function (selectedItem) {
                    //             $scope.selected = selectedItem;
                    //             }, function () {
                    //             $log.info('Modal dismissed at: ' + new Date());
                    //         });    







                    //     // session.disconnect();
                    //     // $scope.deleteUserParam = {};
                    //     // $scope.deleteUserParam.patient_id = $scope.waitingUserId;
                    //     // doctorServices.deleteWaitingUser($scope.deleteUserParam)
                    //     // .then(function(result){
                    //     //     $log.log(result);
                    //     //     })
                    //     // $state.go('doctor');
                    // }
                }else{
                    alert("error");
                }
                })


            





            $scope.progressArray = {};

            $scope.removeDialogText = function(x){
                switch(x){
                    case 1:
                    $scope.progressArray.chiefComplaints = '';
                    break;
                    case 2:
                    $scope.progressArray.hpi = '';
                    break;
                    case 3:
                    $scope.progressArray.pastMedicalHistory = '';
                    break;
                    case 4:
                    $scope.progressArray.pastSurgicalHistory = '';
                    break;
                    case 5:
                    $scope.progressArray.socialHistory = '';
                    break;
                    case 6:
                    $scope.progressArray.familyHistory = '';
                    break;
                    case 7:
                    $scope.progressArray.reviewsOfSystemsvalue = '';
                    break;
                    case 8:
                    $scope.progressArray.physicalExam = '';
                    break;
                    case 9:
                    $scope.progressArray.labs = '';
                    break;
                    case 10:
                    $scope.progressArray.imaging = '';
                    break;
                    case 11:
                    $scope.progressArray.otherStudies = '';
                    break;
                    case 12:
                    $scope.progressArray.assesment = '';
                    break;
                    case 13:
                    $scope.progressArray.planOfCare = '';
                    break;
                    case 14:
                    $scope.progressArray.followUp = '';
                    break;

                }
            }

            $scope.downloadPDF = function(data,ICD,CPT,userCallData){

                $scope.loading = true;
                $scope.progressNotePDFArray = data;
                $scope.progressNotePDFArray.doctorFirstName = " John";
                $scope.progressNotePDFArray.doctorLastName = "Ticks";
                $scope.progressNotePDFArray.diagnosticAssesment =  ICD;
                $scope.progressNotePDFArray.az_cpt_code =  CPT;
                
                $scope.progressNotePDFArray = JSON.stringify(
                {
                    first_name : userCallData.first_name,
                    last_name:userCallData.last_name,
                    gender:userCallData.gender,
                    email:userCallData.email,
                    address1:userCallData.address1,
                    address2:userCallData.address2,
                    phone:userCallData.phone,
                    city:userCallData.city,
                    state:userCallData.state,
                    zip_code:userCallData.zip_code,
                    dateofbirth:moment( userCallData.dateofbirth).format("MM/DD/YYYY"),
                    age: $filter('findAgeFilter')(userCallData.dateofbirth),
                    call_started : moment( userCallData.call_started).format("MM/DD/YYYY HH:mm:ss"),
                    'doctor_instruction':JSON.stringify($scope.progressNotePDFArray)
                });
                var data = $scope.progressNotePDFArray;
                doctorServices.downloadPDF(data)
                .then(function(result){
                    var file_path = result.data; 
                    var a = document.createElement('A');
                    a.href = file_path;
                    a.download = file_path.substr(file_path.lastIndexOf('/') + 1);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    $scope.loading = false;
                    })
            }


            $scope.ICDArray = {};    
            $scope.addeddiagnosisArray = [];
            $scope.searchgenerateICD = function(){
                $scope.param ={};
                $scope.param.key = $('#searchICDText').val();
                if($('#searchICDText').val().length >= 3){
                    $scope.loading = true;
                    doctorServices.getICDService($scope.param)
                    .then(function(result){
                        $scope.loading = false;
                        $scope.ICDArray = result.data[3];
                    })    
                }else{
                    $scope.ICDArray = {};
                }
            }

            $scope.adddiagnosis = function(a,b){
                $scope.ICDArray = {};
                $scope.addeddiagnosisArray.push({"icdCode":a,"description":b});        
            }


            $scope.CPTArray = [];
            $scope.removeSelectedCptBilling = function(x){
                var index = $scope.CPTArray.indexOf(x);
                if(index != -1){
                    $scope.CPTArray.splice(x,1);
                } 
            }
            $scope.selectCPT = function(){
                $scope.loading = true;
                doctorServices.getCPTBilling()
                .then(function(result){
                    if(result.data.success == 1){
                        $scope.loading = false;
                        $scope.cptBilling = result.data.result;    
                         var modalInstance = $uibModal.open({
                            templateUrl: "CPTProgressNoteModal.html",
                            controller: ModalInstanceCtrl,
                            scope: $scope,
                            size:'sm',
                            windowClass: 'getbilling-cpt-pop-class',
                            resolve: {
                                modalProgressValue: function () {
                                return "";
                                },
                                CPTBilling : function(){
                                    return $scope.cptBilling;
                                },
                                sessionResolve : function(){
                                    return '';
                                },
                                meetingRoomURLResolve : function(){
                                    return "";
                                },
                                emailMeetingLinkUrlResolve : function(){
                                    return "";
                                },
                                lockEncounterData : function(){
                                    return "";
                                },
                                disconnectData : function(){
                                    return "";
                                }

                            }

                        });
                        modalInstance.result.then(function (selectedItem) {
                            $scope.selected = selectedItem;
                            }, function () {
                            $log.info('Modal dismissed at: ' + new Date());
                        });  
                    }else{
                        $scope.loading = false;
                        $scope.cptBilling = [];
                    }
                    $log.log(result);
                })

                


            }
            
            $scope.openProgressModal = function(a,b){
                $scope.returningValue = {};
                $scope.returningValue.head = a;
                $scope.returningValue.value = (angular.isUndefined(b)? "": b);


                var modalInstance = $uibModal.open({
                    templateUrl: "progressNoteModal.html",
                    controller: ModalInstanceCtrl,
                    scope: $scope,
                    size:'sm',
                    resolve: {
                        modalProgressValue: function () {
                        return $scope.returningValue;
                        },
                        CPTBilling : function(){
                            return '';
                        },
                        sessionResolve : function(){
                            return '';
                        },
                        meetingRoomURLResolve : function(){
                            return "";
                        },
                        emailMeetingLinkUrlResolve : function(){
                            return "";
                        },
                        lockEncounterData : function(){
                            return "";
                        },
                        disconnectData : function(){
                            return "";
                        }
                    }

                });
                modalInstance.result.then(function (selectedItem) {
                    $scope.selected = selectedItem;
                    }, function () {
                    $log.info('Modal dismissed at: ' + new Date());
                });    

            }

            $scope.saveCallRecord = function(data,ICD,CPT,userCallData,x){
                if(doctorServices.getCallId() != undefined){
                    $scope.loading = true;
                    $scope.isCallSaved = 1;
                    $scope.progressNoteInsArray = data;
                    $scope.progressNoteInsArray.operation = "save";
                    $scope.progressNoteInsArray.diagnosticAssesment =  ICD;
                    $scope.progressNoteInsArray.az_cpt_code =  CPT;
                    $scope.progressNotePDFArray = JSON.stringify(
                        {
                            doctor_instruction:$scope.progressNoteInsArray
                        
                    });
                    var data = $scope.progressNotePDFArray;

                    $scope.lockData = {};
                    $scope.lockData.call_id = doctorServices.getCallId();
                    $scope.lockData.doctor_instruction = data;
                    pdfChartingService.lockCallEncounter($scope.lockData)
                    .then(function(result){
                        if(result.data.status_code == 200){
                            $scope.loading = false;
                            var modalInstance = $uibModal.open({
                                template:'\
                                    <div class="modal-header bootstrap-modal-header">\
                                    <h3 class="modal-title" id="modal-title">Patient Instruction </h3>\
                                    </div>\
                                    <div class="modal-body bootstrap-modal-body" id="modal-body">\
                                    <p>Patient Instructions Saved Successfully.</p>\
                                    </div>\
                                    <div class="modal-footer bootstrap-modal-footer">\
                                        <button class="btn btn-primary" type="button" ng-click="cancel()">OK</button>\
                                    </div>\
                                    ',
                                controller: ModalInstanceCtrl,
                                scope: $scope,
                                size:'sm',
                                windowClass: 'disconnect-pop1-class',
                                resolve: {
                                    modalProgressValue: function () {
                                    return "";
                                    },
                                    CPTBilling : function(){
                                        return "";
                                    },
                                    sessionResolve : function(){
                                        return "";
                                    },
                                    meetingRoomURLResolve : function(){
                                        return "";
                                    },
                                    emailMeetingLinkUrlResolve : function(){
                                        return "";
                                    },
                                    lockEncounterData : function(){
                                        return "";
                                    },
                                    disconnectData : function(){
                                        return "";
                                    }
                                }

                            });
                            modalInstance.result.then(function (selectedItem) {
                                $scope.selected = selectedItem;
                                }, function () {
                                $log.info('Modal dismissed at: ' + new Date());
                            });
                            //$state.go('doctor');
                            //$("#lockBTN2").show();
                            //$("#lockBTN1").hide();
                        }else{
                            $scope.loading = false;
                            alert("error");
                        }

                    })

                }else{
                    alert("please end the call first.");
                    $scope.isCallSaved = 0;
                }

            }

            $scope.lockEncounter = function(data,ICD,CPT,userCallData,x){
                if(doctorServices.getCallId() != undefined){
                    $scope.isCallSaved = 1;

                }else{
                    $scope.isCallSaved = 0;
                }


                if($scope.isCallSaved == 1){
                    $scope.progressNoteInsArray = data;
                    $scope.progressNoteInsArray.operation = "lock";
                    $scope.progressNoteInsArray.diagnosticAssesment =  ICD;
                    $scope.progressNoteInsArray.az_cpt_code =  CPT;
                    $scope.progressNotePDFArray = JSON.stringify(
                        {
                            doctor_instruction:$scope.progressNoteInsArray
                        
                    });
                    var data = $scope.progressNotePDFArray;



                    var modalInstance = $uibModal.open({
                        templateUrl: "progressNoteLockModal.html",
                        controller: ModalInstanceCtrl,
                        scope: $scope,
                        size:'sm',
                        resolve: {
                            modalProgressValue: function () {
                            return "";
                            },
                            CPTBilling : function(){
                                return '';
                            },
                            sessionResolve : function(){
                                return '';
                            },
                            meetingRoomURLResolve : function(){
                                return "";
                            },
                            emailMeetingLinkUrlResolve : function(){
                                return "";
                            },
                            lockEncounterData : function(){
                                return data;
                            },
                            disconnectData : function(){
                                return "";
                            }
                        }

                    });

                    modalInstance.result.then(function (selectedItem) {
                        $scope.selected = selectedItem;
                        }, function () {
                        $log.info('Modal dismissed at: ' + new Date());
                    });
                    
                }else{
                    alert("please end the call first.");
                }
                

            }
        }/* doctor call controller end*/     

        /* doctor logout controller */
        $rootScope.logoutDoctor = function(){
            $scope.loading = true;
            $scope.param ={};
            $scope.param.id =  JSON.parse(localStorage.getItem('pcpDocData')).id;//$cookieStore.get('pcpDocData').id;
            doctorServices.logoutDoctor($scope.param)
            .then(function(result){
                $log.log(result);
                if(result.data.status_code == 200){
                    $scope.loading = false;
                    // docOfflineSocketData.docId = JSON.parse(localStorage.getItem('pcpDocData')).id;
                    // socketService.emit('doctorGoneOffline',{docOfflineSocketData:docOfflineSocketData},function(data){
                    //     $log.log("doctor logout");    
                    // });
                    var docId = JSON.parse(localStorage.getItem('pcpDocData')).id;
                    localStorage.removeItem('pcpDocData');//$cookieStore.remove('pcpDocData');
                    localStorage.removeItem('doc_token');
                    localStorage.removeItem('connect_provider_settings');
                    
                    let removeOnlienDoctor = document.getElementsByClassName('onlineDoctorClass')[0];
                    if(removeOnlienDoctor) removeOnlienDoctor.parentNode.removeChild(removeOnlienDoctor);
                    var docOfflineSocketData = {};
                    
                    
                    $rootScope.isLoggedIn = false;
                    $location.path('/');
                    socketService.on('doctorGoneOffline', function(data){
                        $log.log(data);
                    });
                    socketService.emit('doctorGoneOffline', { docId: docId }, function(data){
                        $log.log(data);
                    }); 
                   $rootScope.$emit('logout_sropinterval', new Date());
                    
                }else{
                    $scope.loading = false;
                    alert("error");
                    return false;
                }
                
                })
        }/* doctor logout controller end*/  

        /*pankaj-- doctor connent to advonow through saml*/

        $rootScope.advinowConnect = function(){
           
            $scope.param ={};
            $scope.param.id =  JSON.parse(localStorage.getItem('pcpDocData')).id;//$cookieStore.get('pcpDocData').id;
            doctorServices.connectAdvinowSaml($scope.param)
            .then(function(result){
                $log.log(result);
                if(result.data.status_code == 200){

                    alert('https://tools.advinow.net/DoctorApp/SAML?pilot&token='+result.data.token);
                    window.open('https://tools.advinow.net/DoctorApp/SAML?pilot&token='+result.data.token, '_blank');
                    
                }else{
                    $scope.loading = false;
                    alert("error");
                    return false;
                }
                
                })
        }

    }








var ModalInstanceCtrl = function ($scope,$rootScope, $uibModalInstance,modalProgressValue,CPTBilling,$uibModal,socketService,$log,$state,sessionResolve,doctorServices,meetingRoomURLResolve,emailMeetingLinkUrlResolve,lockEncounterData,pdfChartingService,disconnectData) {

    $scope.lockPpoupEncounter = function(){
        $scope.loading = true;
        $uibModalInstance.dismiss('cancel');
        $scope.lockData = {};
        $scope.lockData.call_id = doctorServices.getCallId();
        $scope.lockData.doctor_instruction = lockEncounterData;
        pdfChartingService.lockCallEncounter($scope.lockData)
        .then(function(result){
            if(result.data.status_code == 200){
                $scope.loading = false;
                $state.go('doctor');
                //$("#lockBTN2").show();
                //$("#lockBTN1").hide();
            }else{
                $scope.loading = false;
                alert("error");
            }

        })

    }

    $scope.inviteOtherFriendMeeting = function(email,link){
        $scope.loading = true;
        $scope.param = {};
        $scope.param.patientEmail = email;
        $scope.param.docMeetingEmailLink = link;
        doctorServices.sendEmailMeetingLink($scope.param)
        .then(function(result){
            if(result.data.status_code == 200){
                $scope.loading = false;
                $uibModalInstance.dismiss('cancel');
                toastr.success('Email sent successfully');
            }else{
                alert("error");
            }
            })
    }

    $scope.inviteOtherFriendMeetingSMS = function(phone,link){
        $scope.loading = true;
        $scope.param = {};
        $scope.param.patientPhone = phone;
        $scope.param.docMeetingSMSLink = link;
        doctorServices.sendSMSMeetingLink($scope.param)
        .then(function(result){
            if(result.data.status_code == 200){
                $scope.loading = false;
                $uibModalInstance.dismiss('cancel');
                toastr.success('SMS sent successfully');
            }else{
                alert("error");
            }
            })
    }


    $scope.sendMeetingUrlPatient = function(email){
        $scope.loading = true;
        $scope.param = {};
        $scope.param.patientEmail = email;
        $scope.param.docMeetingEmailLink = emailMeetingLinkUrlResolve;
        $scope.param.docName = JSON.parse(localStorage.getItem('pcpDocData')).name;
        doctorServices.sendEmailMeetingLink($scope.param)
        .then(function(result){
            if(result.data.status_code == 200){
                $scope.loading = false;
                $uibModalInstance.dismiss('cancel');
                toastr.success('Email sent successfully');
            }else{
                alert("error");
            }
            })        
    }

    $scope.sendSMSMeetingUrlPatient = function(phone){
        $scope.loading = true;
        $scope.param = {};
        $scope.param.patientPhone = phone;
        $scope.param.docMeetingSMSLink = emailMeetingLinkUrlResolve;
        doctorServices.sendSMSMeetingLink($scope.param)
        .then(function(result){
            if(result.data.status_code == 200){
                $scope.loading = false;
                $uibModalInstance.dismiss('cancel');
                toastr.success('SMS sent successfully');
            }else{
                alert("error");
            }
            })        
    }


    $scope.meetingRoomURLResolve = meetingRoomURLResolve;  

    $scope.callDisconnect = function(x){
        $("#header-navbar-dash").css("pointer-events", 'auto');
        $("#header-navbar-calllog").css("pointer-events", 'auto');
        $("#header-navbar-preCallTest").css("pointer-events", 'auto');
        doctorServices.saveCallEndedAt(new Date());

        //sessionResolve.session.disconnect();

        var disconnectData = {};
        disconnectData.waitngUserId = sessionResolve.waitingUserId;
        disconnectData.callDisconnectByWhom = x;
        /*socketService.emit('callDisconnectedByDoc',{waitingId:"test"},function(data){
            $log.log("call end");
            $log.log(data);
        });*/

        if(x == 1){
            $scope.stopArchiveParam = {};
            $scope.stopArchiveParam.patientId = sessionResolve.waitingUserId;
            $scope.stopArchiveParam.archiveId =doctorServices.getDocArchiveId();
            
            doctorServices.stopDoctorArchive($scope.stopArchiveParam)
            .then(function(result){
                $log.log(result);
            })

            $rootScope.pcpDoctorOpentokSession.disconnect();

        }

        $scope.callSuccess();

        /*
        $uibModalInstance.dismiss('cancel');
        var modalInstance = $uibModal.open({
            templateUrl: "CallDisconnectedPop2.html",
            controller: ModalInstanceCtrl,
            scope: $rootScope,
            size:'sm',
            resolve: {
                modalProgressValue: function () {
                return "";
                },
                CPTBilling : function(){
                    return '';
                },
                sessionResolve : function(){
                    return sessionResolve.waitingUserId;
                },
                meetingRoomURLResolve : function(){
                    return "";
                },
                emailMeetingLinkUrlResolve : function(){
                    return "";
                },
                lockEncounterData : function(){
                    return "";
                },
                disconnectData : function(){
                    return disconnectData;
                }

            }

        });

        modalInstance.result.then(function (selectedItem) {
            $scope.selected = selectedItem;
            }, function () {
            $log.info('Modal dismissed at: ' + new Date());
        });
        */
    }

    $scope.callSuccess = function(){
        $scope.makeCallRecordParam = {};
        $scope.makeCallRecordParam.patientId = sessionResolve.waitingUserId;
        $scope.makeCallRecordParam.archive_id = doctorServices.getDocArchiveId();
        $scope.makeCallRecordParam.call_started = doctorServices.getCallStartedAt();
        $scope.makeCallRecordParam.call_ended =  doctorServices.getCallEndedAt();
        doctorServices.makeCallRecord($scope.makeCallRecordParam)
        .then(function(result){
            if(result.data.status_code == 200){
                $("#lockBTN0").prop("disabled",false);
                $("#lockBTN1").prop("disabled",false);
                $("#extraCallOptions").hide();
                $scope.callId = result.data.result.callId;
                doctorServices.saveCallId($scope.callId);
            }else{
                alert("error");    
            }
            

        })
        
        // if(disconnectData.callDisconnectByWhom == 2 || disconnectData.callDisconnectByWhom == 3){
        //  socketService.emit('callDisconnectedByDoc',{waitingId:"test"},function(data){
           //      $log.log("call end");
           //      $log.log(data);
        //  });    
        // }


        


        // socketService.emit('callDisconnectedByDoc',{waitingId:$scope.userFetchedId},function(data){
        //     $log.log("user added");
        //     $log.log(data);
        // });



        $uibModalInstance.dismiss('cancel');
        // $state.go('doctor');


    }
 
   /*ab---make call implementation during live---(030718)*/
  


    
    if(CPTBilling != ''){
        $scope.cptBilling = CPTBilling;
    }
    $scope.selectedCPTCode = function(a,b){
        
        if(a == true){
            $scope.CPTArray.push(b);    
        }else if(a == false){
            var index = $scope.CPTArray.indexOf(b);
            $scope.CPTArray.splice(index,1);
        }
    }
     /*added on 110818-------------*/
    $scope.confirmdelete = function (callid, index) {
        doctorServices.updatestatusBycallId({ call_id: callid, status: "DELETED" })
            .then(function (result) {
                $log.log(result);
                if (result.data.status_code == 200) {

                    try {
                        $scope.userWaitingList.splice($scope.itemindex, $scope.itemindex );
                    } catch (err) { }
                } else {
                    alert("error");
                   
                }
            })
        $uibModalInstance.dismiss('cancel');
      

    };
    /*----------------------------*/
    $scope.cancel = function () {
        $uibModalInstance.dismiss('cancel');
        
    };

    switch(modalProgressValue.head){
        case 1: 
        $scope.modalHead = "Chief Complaints";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 2: 
        $scope.modalHead = "History of Present Illness (HPI)";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 3: 
        $scope.modalHead = "Past Medical History";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 4: 
        $scope.modalHead = "Past Surgical History";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 5: 
        $scope.modalHead = "Social History";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 6: 
        $scope.modalHead = "Family History";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 7: 
        $scope.modalHead = "Review of systems";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 8: 
        $scope.modalHead = "Physical Exam";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 9: 
        $scope.modalHead = "Labs";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 10: 
        $scope.modalHead = "Imaging";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 11: 
        $scope.modalHead = "Other Studies";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 12: 
        $scope.modalHead = "Assesment";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 13: 
        $scope.modalHead = "Plan of Care";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
        case 14: 
        $scope.modalHead = "Follow Up";
        $scope.modalInputValue = modalProgressValue.value;     
        break;
    }

    $scope.saveProgressNote = function(x){

        switch(modalProgressValue.head){
        case 1: 
        $scope.progressArray.chiefComplaints = x;
        break;
        case 2: 
        $scope.progressArray.hpi = x;
        break;
        case 3: 
        $scope.progressArray.pastMedicalHistory = x;
        break;
        case 4: 
        $scope.progressArray.pastSurgicalHistory = x;
        break;
        case 5: 
        $scope.progressArray.socialHistory = x;
        break;
        case 6: 
        $scope.progressArray.familyHistory = x;
        break;
        case 7: 
        $scope.progressArray.reviewsOfSystemsvalue = x;
        break;
        case 8: 
        $scope.progressArray.physicalExam = x;
        break;
        case 9: 
        $scope.progressArray.labs = x;
        break;
        case 10: 
        $scope.progressArray.imaging = x;
        break;
        case 11: 
        $scope.progressArray.otherStudies = x;
        break;
        case 12: 
        $scope.progressArray.assesment = x;
        break;
        case 13: 
        $scope.progressArray.planOfCare = x;
        break;
        case 14: 
        $scope.progressArray.followUp = x;
        break;
    }        

    $uibModalInstance.dismiss('cancel');
    }

}


})();

